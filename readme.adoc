= Neo4j-GraphQL Extension
:img: docs/img
:branch: 4.0

image::https://github.com/neo4j-graphql/graphql-community/raw/master/images/neo4j-graphql-logo.png[float=right,width=200]

This is a GraphQL-Endpoint extension for Neo4j.
It is part of the https://grandstack.io[GRANDstack^]

*This readme assumes you are somewhat familiar with http://graphql.org/[GraphQL^] and minimally with http://neo4j.com/developer/cypher[Cypher].*

Based on your _GraphQL schema_, it translates GraphQL _Queries_ and _Mutations_ into Cypher statements and executes them on Neo4j.

It offers both an *HTTP API*, as well as, Neo4j Cypher *Procedures* to execute and manage your GraphQL API.


== Installation

Download and install http://neo4j.com/download[Neo4j Desktop^]

Neo4j Desktop provides a quick install button for *neo4j-graphql*.

After creating your database you can find it under "Manage" in the "Plugins" tab for a single click install.

image::{img}/desktop-graphql.jpg[width=600]

=== Use with neo4j-graphql-cli

This extension is utilized, when you use https://www.npmjs.com/package/neo4j-graphql-cli[`neo4j-graphql-cli`^]

This tool

1. launches a http://neo4j.com/sandbox[Neo4j Sandbox] with your GraphQL schema
2. provides the `/graphql/` endpoint,
3. a Neo4j server,
4. an hosted GraphiQL for it.

----
npm install -g neo4j-graphql-cli
neo4j-graphql movies-schema.graphql
----

== Quickstart

To generate some graph data in Neo4j just run http://localhost:7474/browser?cmd=play&arg=movie%20graph[`:play movie graph`^] in your Neo4j Browser.

=== GraphiQL

The best tool to use is https://electronjs.org/apps/graphiql[GraphiQL^] the GraphQL UI.
Get and install it.

Enter your GraphQL URL, like `+http://localhost:7474/graphql/<schema>+`

where `<schema>` is the name of your graphql schema (the default schema is `neo4j`)

If your Neo4j Server runs with *authentication enabled*, add the appropriate Basic-Auth (https://www.base64encode.org/[base64 encoded^]) `username:password` header in the "Edit HTTP Headers" screen.

.Command to generate the `Authorization` header value.
----
echo "Basic $(echo -n "neo4j:<password>" | base64)"
----

=== Uploading a GraphQL Schema

Here is a small example schema for the movie data.
Just a Movie with actors, and a Person with movies.

Simple properties are mapped directly while the relationships are mapped to fields `movies` and `actors`

.Movies Schema
[source,graphql]
----
type Movie  {
  title: String!
  released: Int
  actors: [Person] @relation(name:"ACTED_IN",direction:IN)
}
type Person {
  name: String!
  born: Int
  movies: [Movie] @relation(name:"ACTED_IN")
}
----

You can POST a GraphQL schema to the `/graphql/<schema>/idl` endpoint or run the `CALL graphql.idl('schema-text')` procedure.

The payload is parsed and stored in Neo4j and used subsequently as the backing GraphQL schema for validating and executing queries.

[source,cypher]
----
CALL graphql.idl('
type Movie  {
  title: String!
  released: Int
  tagline: String
  actors: [Person] @relation(name:"ACTED_IN",direction:IN)
}
type Person {
  name: String!
  born: Int
  movies: [Movie] @relation(name:"ACTED_IN")
}
')
----

You should then be able to see your schema in the _Docs_ section of GraphiQL.

This also gives you auto-completion, validation and hints when writing queries.

With `graphql.reset()` you can trigger the reset of you schema.
But it also updates automatically if changed on other cluster members.
Latest after 10 seconds.

To visualize your GraphQL schema in Neo4j Browser use: `call graphql.schema()`.

image::{img}/graphql.schema.jpg[width=600]

Using

----
RETURN graphql.getIdl()
----

you'll get back a string representation of the currently used schema.

=== New Neo4j-GraphQL-Java Integration

This plugin uses an https://github.com/neo4j-graphql/neo4j-graphql-java[independent transpiler (neo4j-graphql-java) of GraphQL to Cypher] which can also be used for your own GraphQL servers or middleware on the JVM.

This takes a given GraphQL schema, augments it and then uses that schema to generate Cypher queries from incoming GraphQL queries.

To learn more about the auto generation features provided by this plugin take a look https://github.com/neo4j-graphql/neo4j-graphql-java#documentation[at the documentation of the neo4j-graphql-java library] used by this plugin.

Here is a query example against the movie graph:

[source,graphql]
----
{
  person(born:1950) {
    name, born
    movies(first: 4) {
      title
      actors {
        name
      }
    }
  }
}
----

image:docs/img/neo4j-graphql-java.png[width:800]

=== Procedures

This library also comes with Cypher Procedures to execute GraphQL from within Neo4j.

.Simple Procedure Query
[source,cypher]
----
CALL graphql.query('{ Person(born: 1961) { name, born } }')
----

.Advanced Procedure Query with parameters and post-processing
[source,cypher]
----
WITH 'query ($year:Long,$limit:Int) { Movie(released: $year, first:$limit) { title, actors {name} } }' as query

CALL graphql.query(query,{year:1995,limit:5}) YIELD result

UNWIND result.Movie as movie
RETURN movie.title, [a IN movie.actors | a.name] as actors
----

image::{img}/graphql.execute.jpg[]

.Update with Mutation
[source,cypher]
----
CALL graphql.execute('mutation { createMovie(title:"The Shape of Water", released:2018)}')
----

== Other Information

*Please* leave link:/issues[Feedback and Issues^]

You can get quick answers on http://neo4j.com/slack[Neo4j-Users Slack^] in the https://neo4j-users.slack.com/messages/C5ET7S24R[`#neo4j-graphql` channel^]

License: Apache License v2.

This branch for Neo4j {branch}.x

image:https://travis-ci.org/neo4j-contrib/neo4j-graphql.svg?branch={branch}["Build Status", link="https://travis-ci.org/neo4j-contrib/neo4j-graphql"]

== Advanced Usage

The extension works with Neo4j 4.x, the code on this branch is for *{branch}*.

Please consult the https://neo4j.com/docs/operations-manual/current/configuration/file-locations/[Neo4j documentation^] for file locations for the other editions on the different operating systems.

=== Manual Installation

1. Download the https://github.com/neo4j-graphql/neo4j-graphql/releases[appropriate neo4j-graphql release^] for your version.
2. Copy the _jar-file_ into Neo4j's `plugins` directory
3. Edit the Neo4j settings (`$NEO4J_HOME/conf/neo4j.conf`) to add: +
`dbms.unmanaged_extension_classes=org.neo4j.graphql=/graphql`
4. You might need to add `,graphql.*` if your config contains this line: +
`dbms.security.procedures.whitelist=`
5. (Re)start your Neo4j server

NOTE: _Neo4j Desktop_: the configuration is available under *Manage -> Settings*, the `plugins` folder via *Open Folder*.

[NOTE]
====
If you run Neo4j via Docker:

* put the jar-file into a `/plugins` directory and make it available to the container via `-v /path/to/plugins:/plugins`
* also add to your environment: `+-e NEO4J_dbms_unmanaged__extension__classes=org.neo4j.graphql=/graphql+`.
====

=== Building manually

[subst=attributes]
----
git clone https://github.com/neo4j-graphql/neo4j-graphql
cd neo4j-graphql
git checkout {branch}
mvn clean package
cp target/neo4j-graphql-*.jar $NEO4J_HOME/plugins
echo 'dbms.unmanaged_extension_classes=org.neo4j.graphql=/graphql' >> $NEO4J_HOME/conf/neo4j.conf
$NEO4J_HOME/bin/neo4j restart
----

NOTE: You might need to add `,graphql.*` if your config contains this line: `dbms.security.procedures.whitelist=`

//=== Procedures
//
//You can even visualize remote graphql schemas, e.g. here from the https://developer.github.com/v4/[GitHub GraphQL API^].
//Make sure to generate the https://developer.github.com/v4/guides/forming-calls/#authenticating-with-graphql[Personal Access Token^] to use in your account settings.
//
//[source,cypher]
//----
//call graphql.introspect("https://api.github.com/graphql",{Authorization:"bearer d8xxxxxxxxxxxxxxxxxxxxxxx"})
//----
//
//image:{img}/graphql.introspect-github.jpg[width=600]

== Resources

=== Neo4j-GraphQL

* http://grandstack.io[GRAND Stack (GraphQL React Apollo Neo4j Database)^]
* https://github.com/neo4j-graphql[neo4j-graphql^] Tools and Libraries related to Neo4j's GraphQL support
* https://neo4j.com/developer/graphql[GraphQL page^] on neo4j.com
* https://neo4j.com/blog/cypher-graphql-neo4j-3-1-preview/[GraphQL inspired Cypher features^] Map projections and Pattern comprehensions

=== Libraries & Tools

* https://facebook.github.io/graphq[GraphQL Specification^]
* https://github.com/graphql-java/graphql-java[GraphQL-Java^] which we use in this project
* https://github.com/skevy/graphiql-app[GraphiQL Electron App^]

////

=== Similar Projects

* https://github.com/solidsnack/GraphpostgresQL[GraphQL for Postgres^] as an inspiration of schema -> native queries
* https://github.com/jhwoodward/neo4j-graphQL[Schema Based GraphQL to Cypher in JavaScript]
* https://github.com/jameskyburz/graphqlcypherquery[GraphQL to Cypher translator (w/o schema)]
* https://github.com/JamesKyburz/graphql2cypher[GraphQL parser to Cypher]

////

// * https://github.com/facebook/dataloader
// * http://graphql.org/learn/serving-over-http/[Serving over HTTP]

////
echo "Authorization: Basic $(echo -n "neo4j:test" | base64)"
"Authorization: Basic bmVvNGo6dGVzdA=="
////

////

== Using an http client (curl)

=== POST Schema IDL

----
curl  -u neo4j:<password> -i -XPOST -d'type Person { name: String, born: Int }' http://localhost:7474/graphql/neo4j/idl

{Person=MetaData{type='Person', ids=[], indexed=[], properties={name=PropertyType(name=String, array=false, nonNull=false), born=PropertyType(name=Int, array=false, nonNull=false)}, labels=[], relationships={}}}


curl  -u neo4j:<password> -i -XPOST -d @movies-schema.graphql http://localhost:7474/graphql/neo4j/idl
----


=== Query the Schema

----
curl  -u neo4j:<password> -i -XPOST -d'{"query": "query {__schema {types {kind, name, description}}}"}' -H accept:application/json -H content-type:application/json http://localhost:7474/graphql/neo4j

{"data":{"__schema":{"types":[{"kind":"OBJECT","name":"QueryType","description":null},{"kind":"OBJECT","name":"Movie","description":"Movie-Node"},....
----

----
query {__schema {queryType {
  kind,description,fields {
    name
  }
}}}
----

=== Get All People

----
curl  -u neo4j:<password>  -i -XPOST -d'{"query": "query AllPeopleQuery { Person {name,born} } }"}' -H accept:application/json -H content-type:application/json http://localhost:7474/graphql/neo4j


HTTP/1.1 200 OK
Date: Mon, 24 Oct 2016 21:40:15 GMT
Content-Type: application/json
Access-Control-Allow-Origin: *
Transfer-Encoding: chunked
Server: Jetty(9.2.9.v20150224)

{"data":{"Person":[{"name":"Michael Sheen","born":1969},{"name":"Jack Nicholson","born":1937},{"name":"Nathan Lane","born":1956},{"name":"Philip Seymour Hoffman","born":1967},{"name":"Noah Wyle","born":1971},{"name":"Rosie O'Donnell","born":1962},{"name":"Greg Kinnear","born":1963},{"name":"Susan Sarandon","born":1946},{"name":"Takeshi Kitano","born":1947},{"name":"Gary Sinise","born":1955},{"name":"John Goodman","born":1960},{"name":"Christina Ricci","born":1980},{"name":"Jay Mohr","born":1970},{"name":"Ben Miles","born":1967},{"name":"Carrie Fisher","born":1956},{"name":"Christopher Guest","born":1948},{"name
...
----

=== Get one Person by name with Parameter

----
curl  -u neo4j:<password> -i -XPOST -d'{"query":"query PersonQuery($name:String!) { Person(name:$name) {name,born} }", "variables":{"name":"Kevin Bacon"}}' -H content-type:application/json http://localhost:7474/graphql/neo4j

HTTP/1.1 200 OK
Date: Mon, 24 Oct 2016 21:40:38 GMT
Content-Type: application/json
Access-Control-Allow-Origin: *
Transfer-Encoding: chunked
Server: Jetty(9.2.9.v20150224)

{"data":{"Person":[{"name":"Kevin Bacon","born":1958}]}}
----

=== Get one Person by name literal with related movies

----
curl  -u neo4j:<password> -i -XPOST -d'{"query":"query PersonQuery { Person(name:\"Tom Hanks\") {name, born, actedIn {title, released} } }"}' -H content-type:application/json http://localhost:7474/graphql/neo4j
HTTP/1.1 200 OK
Date: Tue, 25 Oct 2016 03:17:08 GMT
Content-Type: application/json
Access-Control-Allow-Origin: *
Transfer-Encoding: chunked
Server: Jetty(9.2.9.v20150224)

{"data":{"Person":[{"name":"Tom Hanks","born":1956,"actedIn":[{"title":"Charlie Wilson's War","released":2007},{"title":"A League of Their Own","released":1992},{"title":"The Polar Express","released":2004},{"title":"The Green Mile","released":1999},{"title":"Cast Away","released":2000},{"title":"Apollo 13","released":1995},{"title":"The Da Vinci Code","released":2006},{"title":"Cloud Atlas","released":2012},{"title":"Joe Versus the Volcano","released":1990},{"title":"Sleepless in Seattle","released":1993},{"title":"You've Got Mail","released":1998},{"title":"That Thing You Do","released":1996}]}]}}
----

=== Schema first

----
curl -X POST http://localhost:7474/graphql/neo4j/idl -d 'type Person {
            name: String!
            born: Int
            movies: [Movie] @relation(name:"ACTED_IN")
            totalMoviesCount: Int @cypher(statement: "WITH {this} AS this MATCH (this)-[:ACTED_IN]->() RETURN count(*) AS totalMoviesCount")
            recommendedColleagues: [Person] @cypher(statement: "WITH {this} AS this MATCH (this)-[:ACTED_IN]->()<-[:ACTED_IN]-(other) RETURN other")
        }

        type Movie  {
            title: String!
            released: Int
            tagline: String
            actors: [Person] @relation(name:"ACTED_IN",direction:IN)
         }' -u neo4j:****
----

////
